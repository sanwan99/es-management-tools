# 悬挂索引查询方法

## 1. 官方API查询（推荐）

### 查看所有悬挂索引
```bash
curl -s "http://192.168.0.93:9201/_dangling"
```

**返回示例**：
```json
{
  "dangling_indices": [
    {
      "index_name": "test_index",
      "index_uuid": "aAsFqTI0Tc2W0LCWFTNi-A",
      "creation_date": "2023-01-01T00:00:00Z",
      "node_ids": ["node1", "node2"]
    }
  ]
}
```

### 查看指定悬挂索引详情
```bash
curl -s "http://192.168.0.93:9201/_dangling/{index_uuid}"
```

## 2. 集群状态查询

### 通过集群状态查看
```bash
# 查看集群完整状态（包含悬挂索引信息）
curl -s "http://192.168.0.93:9201/_cluster/state?pretty" | grep -A10 -B10 "dangling"

# 只查看元数据部分
curl -s "http://192.168.0.93:9201/_cluster/state/metadata?pretty" | grep -i dangling
```

### 查看待处理任务
```bash
# 悬挂索引处理任务通常会出现在待处理任务中
curl -s "http://192.168.0.93:9201/_cluster/pending_tasks?pretty"
```

## 3. 节点级别查询

### 查看各节点的悬挂索引
```bash
# 查看所有节点统计（包含悬挂索引信息）
curl -s "http://192.168.0.93:9201/_nodes/stats?pretty" | grep -A5 -B5 "dangling"

# 查看指定节点的悬挂索引
curl -s "http://192.168.0.93:9201/_nodes/{node_id}/stats?pretty"
```

## 4. 日志文件查询

### 查看ES日志中的悬挂索引信息
```bash
# 查看悬挂索引相关日志
grep -i "dangling" /home/es/logs-eth/greencloud-log-center.log

# 查看索引发现日志
grep -i "found.*dangling\|discovered.*dangling" /home/es/logs-eth/greencloud-log-center.log

# 查看悬挂索引处理日志
grep -i "DanglingIndicesState" /home/es/logs-eth/greencloud-log-center.log
```

## 5. 文件系统级别查询

### 检查数据目录中的孤儿索引
```bash
# 查看数据目录结构
find /data/es/data-eth/nodes/0/indices/ -name "*.lock" -o -name "*.si" | head -10

# 对比集群中的索引和磁盘上的索引
# 先获取集群中的索引列表
curl -s "http://192.168.0.93:9201/_cat/indices?h=index" > cluster_indices.txt

# 再获取磁盘上的索引目录
ls /data/es/data-eth/nodes/0/indices/ > disk_indices.txt

# 比较差异
comm -23 <(sort disk_indices.txt) <(sort cluster_indices.txt)
```

## 6. 监控脚本

### 自动化悬挂索引检查脚本
```bash
#!/bin/bash
# dangling_indices_check.sh

ES_HOST="192.168.0.93:9201"
LOGFILE="/tmp/dangling_indices_check.log"

echo "$(date): 开始检查悬挂索引" >> $LOGFILE

# 检查悬挂索引
DANGLING_RESULT=$(curl -s "http://$ES_HOST/_dangling")
DANGLING_COUNT=$(echo $DANGLING_RESULT | jq '.dangling_indices | length' 2>/dev/null)

if [ "$DANGLING_COUNT" -gt 0 ]; then
    echo "$(date): 发现 $DANGLING_COUNT 个悬挂索引" >> $LOGFILE
    echo $DANGLING_RESULT | jq '.dangling_indices[] | {index_name, index_uuid, creation_date}' >> $LOGFILE
else
    echo "$(date): 未发现悬挂索引" >> $LOGFILE
fi

# 检查集群状态应用时间
CLUSTER_STATS=$(curl -s "http://$ES_HOST/_cluster/stats")
echo "$(date): 集群状态检查完成" >> $LOGFILE
```

## 7. 常见返回结果解读

### 正常情况（无悬挂索引）
```json
{
  "dangling_indices": []
}
```

### 有悬挂索引的情况
```json
{
  "dangling_indices": [
    {
      "index_name": "logstash-2023.07.15",
      "index_uuid": "aAsFqTI0Tc2W0LCWFTNi-A",
      "creation_date": "2023-07-15T00:00:00Z",
      "node_ids": ["node-warm-1", "node-warm-2"]
    },
    {
      "index_name": "test_index_old",
      "index_uuid": "bBsFqTI0Tc2W0LCWFTNi-B",
      "creation_date": "2023-07-10T00:00:00Z",
      "node_ids": ["node-warm-3"]
    }
  ]
}
```

### 字段含义
- `index_name`: 索引名称
- `index_uuid`: 索引UUID（用于删除或导入操作）
- `creation_date`: 索引创建时间
- `node_ids`: 包含该悬挂索引的节点列表

## 8. 故障排查场景

### 如果API无响应
```bash
# 直接查看日志
tail -f /home/es/logs-eth/greencloud-log-center.log | grep -i dangling

# 检查集群状态
curl -s "http://192.168.0.93:9201/_cluster/health"
```

### 如果怀疑有悬挂索引但API显示为空
```bash
# 检查不同节点的API
curl -s "http://192.168.0.90:9201/_dangling"
curl -s "http://192.168.0.91:9201/_dangling"
curl -s "http://192.168.0.92:9201/_dangling"

# 检查数据目录
ls -la /data/es/data-eth/nodes/0/indices/ | wc -l
```

## 9. 处理建议

### 查到悬挂索引后的处理流程
```bash
# 1. 首先备份重要数据
# 2. 确认悬挂索引是否需要保留
# 3. 选择删除或导入操作

# 删除悬挂索引
curl -X DELETE "http://192.168.0.93:9201/_dangling/{index_uuid}?accept_data_loss=true"

# 导入悬挂索引
curl -X POST "http://192.168.0.93:9201/_dangling/{index_uuid}?accept_data_loss=true"
```

### 批量处理悬挂索引
```bash
#!/bin/bash
# 批量删除悬挂索引脚本

ES_HOST="192.168.0.93:9201"

# 获取所有悬挂索引
DANGLING_INDICES=$(curl -s "http://$ES_HOST/_dangling" | jq -r '.dangling_indices[].index_uuid')

for uuid in $DANGLING_INDICES; do
    echo "正在删除悬挂索引: $uuid"
    curl -X DELETE "http://$ES_HOST/_dangling/$uuid?accept_data_loss=true"
    echo "删除完成: $uuid"
done
```

## 10. 预防措施

### 避免产生悬挂索引的方法
```bash
# 1. 优雅关闭节点
curl -X POST "http://node:9200/_cluster/nodes/_local/_shutdown"

# 2. 删除索引前确保所有节点在线
curl -s "http://192.168.0.93:9201/_cluster/health" | jq '.number_of_nodes'

# 3. 定期检查悬挂索引
curl -s "http://192.168.0.93:9201/_dangling" | jq '.dangling_indices | length'
```

### 配置自动处理
```yaml
# elasticsearch.yml
# 禁止自动导入悬挂索引（推荐）
gateway.auto_import_dangling_indices: false

# 或者允许自动导入（谨慎使用）
gateway.auto_import_dangling_indices: true
```

## 11. 监控告警

### 监控指标
```bash
# 悬挂索引数量
dangling_indices_count

# 悬挂索引处理时间
dangling_indices_processing_time

# 集群状态应用时间
cluster_state_apply_time
```

### 告警规则
```yaml
# 悬挂索引告警
- alert: DanglingIndicesFound
  expr: elasticsearch_dangling_indices_count > 0
  for: 5m
  annotations:
    summary: "发现悬挂索引"
    description: "集群中发现 {{ $value }} 个悬挂索引"

# 悬挂索引处理时间告警
- alert: SlowDanglingIndicesProcessing
  expr: elasticsearch_dangling_indices_processing_time > 30
  for: 2m
  annotations:
    summary: "悬挂索引处理时间过长"
    description: "悬挂索引处理时间超过 {{ $value }} 秒"
```

## 注意事项

**重要提醒**：
- 悬挂索引操作需要加 `accept_data_loss=true` 参数
- 操作前务必确认数据重要性
- 建议在业务低峰期进行操作
- 操作后检查集群状态是否正常
- 删除悬挂索引是不可逆操作，请谨慎执行

**最佳实践**：
1. 定期检查悬挂索引状态
2. 建立悬挂索引处理流程
3. 优雅关闭节点避免产生悬挂索引
4. 监控悬挂索引处理时间
5. 在测试环境验证操作流程