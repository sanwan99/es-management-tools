# ES索引模板优化方案

## 现状分析

基于2025-07-17的实际数据：
- **总索引数**: 218个
- **总分片数**: 约540个分片 (平均2.5分片/索引)
- **超大索引** (>50GB): 3个，合计分片9个
- **大索引** (10-50GB): 20个，合计分片50个
- **中索引** (1-10GB): 50个，合计分片130个
- **小索引** (<1GB): 145个，合计分片350个

## 优化目标

**分片数量优化**：
- 小索引(<1GB): 350个分片 → 145个分片 (减少205个)
- 中索引(1-10GB): 130个分片 → 50个分片 (减少80个)
- 大索引(10-50GB): 50个分片 → 40个分片 (减少10个)
- 超大索引(>50GB): 保持9个分片

**总体效果**: 540个分片 → 244个分片 (减少55%)

## 具体实施方案

### 步骤1：清理旧模板

```bash
# 删除冗余的旧模板
curl -X DELETE "http://192.168.0.93:9201/_template/logstash-loghub-month-tpl"
curl -X DELETE "http://192.168.0.93:9201/_template/logstash-medium-volume-logs-prd"
curl -X DELETE "http://192.168.0.93:9201/_template/logstash-high-volume-logs-prd"
```

### 步骤2：创建新的分层模板

#### 模板1：超小索引 (默认1分片)
```bash
curl -X PUT "http://192.168.0.93:9201/_template/logstash-tiny-volume" \
-H 'Content-Type: application/json' \
-d '{
  "order": 1,
  "index_patterns": ["logstash-loghub-*"],
  "settings": {
    "index": {
      "highlight": {"max_analyzed_offset": "1000000"},
      "routing": {"allocation": {"require": {"node-type": "hot"}}},
      "refresh_interval": "30s",
      "number_of_shards": "1",
      "translog": {
        "flush_threshold_size": "512mb",
        "sync_interval": "30s",
        "durability": "async"
      },
      "merge": {
        "scheduler": {
          "max_thread_count": "1",
          "max_merge_count": "100"
        }
      },
      "number_of_replicas": "0"
    }
  },
  "mappings": {
    "properties": {
      "logStore": {"type": "keyword"},
      "traceId": {"type": "keyword"},
      "internetIp": {"type": "keyword"},
      "os": {"type": "keyword"},
      "level": {"type": "keyword"},
      "tomcat": {"type": "keyword"},
      "project": {"type": "keyword"},
      "thread": {"type": "keyword"},
      "message": {"type": "text"},
      "logsClientVersion": {"type": "keyword"},
      "uuid": {"type": "keyword"},
      "spanId": {"type": "keyword"},
      "hostname": {"type": "keyword"},
      "msgObj": {"type": "object"},
      "sourceIp": {"type": "keyword"},
      "topic": {"type": "keyword"},
      "location": {"type": "keyword"},
      "time": {"type": "date"}
    }
  }
}'
```

#### 模板2：大索引 (2分片)
```bash
curl -X PUT "http://192.168.0.93:9201/_template/logstash-large-volume" \
-H 'Content-Type: application/json' \
-d '{
  "order": 5,
  "index_patterns": [
    "logstash-loghub-logs-product-room-api-prd-*",
    "logstash-loghub-logs-product-room-pms-prd-*",
    "logstash-loghub-logs-resrv-pms-api-prd-*",
    "logstash-loghub-logs-website-platform-api-gcplatform-logstore-*",
    "logstash-loghub-logs-platform-member-crm-api-prd-*",
    "logstash-loghub-logs-platform-coupon-api-prd-*",
    "logstash-loghub-logs-website-platform-api-common-*",
    "logstash-loghub-error-ap-api-prd-*",
    "logstash-loghub-logs-platform-int-ctrip-*",
    "logstash-loghub-logs-message-center-prd-*",
    "logstash-loghub-logs-website-platform-api-gc-distribution-common-*",
    "logstash-loghub-logs-platform-int-meituan-*",
    "logstash-loghub-logs-youshu-service-logstore-*",
    "logstash-loghub-logs-gcbase-iam-web-prd-*",
    "logstash-loghub-logs-travel-ship-prd-*",
    "logstash-loghub-logs-opms-mihotel-opms-mihotel-*",
    "logstash-loghub-logs-platform-member-marketing-api-prd-*",
    "logstash-loghub-logs-resrv-pms-exception-prd-*",
    "logstash-loghub-logs-dps-prd-*",
    "logstash-loghub-logs-platform-zhz-zhz-zmsg-prd-*"
  ],
  "settings": {
    "index": {
      "highlight": {"max_analyzed_offset": "1000000"},
      "routing": {"allocation": {"require": {"node-type": "hot"}}},
      "refresh_interval": "30s",
      "number_of_shards": "2",
      "translog": {
        "flush_threshold_size": "512mb",
        "sync_interval": "30s",
        "durability": "async"
      },
      "merge": {
        "scheduler": {
          "max_thread_count": "1",
          "max_merge_count": "100"
        }
      },
      "number_of_replicas": "0"
    }
  },
  "mappings": {
    "properties": {
      "logStore": {"type": "keyword"},
      "traceId": {"type": "keyword"},
      "internetIp": {"type": "keyword"},
      "os": {"type": "keyword"},
      "level": {"type": "keyword"},
      "tomcat": {"type": "keyword"},
      "project": {"type": "keyword"},
      "thread": {"type": "keyword"},
      "message": {"type": "text"},
      "logsClientVersion": {"type": "keyword"},
      "uuid": {"type": "keyword"},
      "spanId": {"type": "keyword"},
      "hostname": {"type": "keyword"},
      "msgObj": {"type": "object"},
      "sourceIp": {"type": "keyword"},
      "topic": {"type": "keyword"},
      "location": {"type": "keyword"},
      "time": {"type": "date"}
    }
  }
}'
```

#### 模板3：超大索引 (3分片)
```bash
curl -X PUT "http://192.168.0.93:9201/_template/logstash-ultra-large-volume" \
-H 'Content-Type: application/json' \
-d '{
  "order": 10,
  "index_patterns": [
    "logstash-loghub-logs-iroom-prd-*",
    "logstash-loghub-logs-platform-int-int-*",
    "logstash-loghub-logs-guardian-prd-*"
  ],
  "settings": {
    "index": {
      "highlight": {"max_analyzed_offset": "1000000"},
      "routing": {"allocation": {"require": {"node-type": "hot"}}},
      "refresh_interval": "30s",
      "number_of_shards": "3",
      "translog": {
        "flush_threshold_size": "512mb",
        "sync_interval": "30s",
        "durability": "async"
      },
      "merge": {
        "scheduler": {
          "max_thread_count": "1",
          "max_merge_count": "100"
        }
      },
      "number_of_replicas": "0"
    }
  },
  "mappings": {
    "properties": {
      "logStore": {"type": "keyword"},
      "traceId": {"type": "keyword"},
      "internetIp": {"type": "keyword"},
      "os": {"type": "keyword"},
      "level": {"type": "keyword"},
      "tomcat": {"type": "keyword"},
      "project": {"type": "keyword"},
      "thread": {"type": "keyword"},
      "message": {"type": "text"},
      "logsClientVersion": {"type": "keyword"},
      "uuid": {"type": "keyword"},
      "spanId": {"type": "keyword"},
      "hostname": {"type": "keyword"},
      "msgObj": {"type": "object"},
      "sourceIp": {"type": "keyword"},
      "topic": {"type": "keyword"},
      "location": {"type": "keyword"},
      "time": {"type": "date"}
    }
  }
}'
```

### 步骤3：验证配置

```bash
# 查看模板优先级
curl -s "http://192.168.0.93:9201/_template" | jq 'to_entries[] | {name: .key, order: .value.order, patterns: .value.index_patterns}'

# 测试模板匹配
curl -X PUT "http://192.168.0.93:9201/test-logstash-loghub-logs-test-prd-2025-07-18"
curl -s "http://192.168.0.93:9201/test-logstash-loghub-logs-test-prd-2025-07-18/_settings?pretty" | grep "number_of_shards"

# 测试大索引模板
curl -X PUT "http://192.168.0.93:9201/test-logstash-loghub-logs-iroom-prd-2025-07-18"
curl -s "http://192.168.0.93:9201/test-logstash-loghub-logs-iroom-prd-2025-07-18/_settings?pretty" | grep "number_of_shards"

# 清理测试索引
curl -X DELETE "http://192.168.0.93:9201/test-logstash-loghub-logs-test-prd-2025-07-18"
curl -X DELETE "http://192.168.0.93:9201/test-logstash-loghub-logs-iroom-prd-2025-07-18"
```

### 步骤4：监控效果

```bash
# 创建监控脚本
cat > /tmp/shard_monitor.sh << 'EOF'
#!/bin/bash
TODAY=$(date +%Y-%m-%d)
echo "=== $TODAY 新索引分片统计 ==="
echo "超大索引 (>50GB):"
curl -s "http://192.168.0.93:9201/_cat/indices?h=index,pri,store.size" | grep "$TODAY" | grep -E "iroom-prd|platform-int-int|guardian-prd" | awk '{print $1, $2"分片", $3}'

echo -e "\n大索引 (10-50GB):"
curl -s "http://192.168.0.93:9201/_cat/indices?h=index,pri,store.size" | grep "$TODAY" | grep -E "product-room-api-prd|product-room-pms-prd|resrv-pms-api-prd|website-platform-api-gcplatform-logstore|platform-member-crm-api-prd|platform-coupon-api-prd|website-platform-api-common|error-ap-api-prd|platform-int-ctrip|message-center-prd|website-platform-api-gc-distribution-common|platform-int-meituan|youshu-service-logstore|gcbase-iam-web-prd|travel-ship-prd|opms-mihotel-opms-mihotel|platform-member-marketing-api-prd|resrv-pms-exception-prd|dps-prd|platform-zhz-zhz-zmsg-prd" | awk '{print $1, $2"分片", $3}'

echo -e "\n分片总数统计:"
TOTAL_SHARDS=$(curl -s "http://192.168.0.93:9201/_cat/indices?h=pri" | grep "$TODAY" | awk '{sum+=$1} END {print sum}')
INDEX_COUNT=$(curl -s "http://192.168.0.93:9201/_cat/indices?h=index" | grep "$TODAY" | wc -l)
echo "今日索引数: $INDEX_COUNT"
echo "今日分片数: $TOTAL_SHARDS"
echo "平均分片数: $(echo "scale=2; $TOTAL_SHARDS / $INDEX_COUNT" | bc)"
EOF

chmod +x /tmp/shard_monitor.sh
```

## 预期效果

### 分片数量优化
- **当前**: 540个分片/天
- **优化后**: 244个分片/天
- **减少**: 296个分片/天 (55%)

### 性能提升预期
- **集群状态同步时间**: 90秒 → 30秒
- **索引创建速度**: 提升50%
- **内存使用**: 降低40%
- **故障恢复速度**: 提升3倍

### 长期效果 (30天)
- **分片总数**: 16,200个 → 7,320个
- **集群状态文件大小**: 减少55%
- **节点被踢出概率**: 降低80%

## 回滚方案

如果需要回滚：
```bash
# 恢复原始模板
curl -X PUT "http://192.168.0.93:9201/_template/logstash-loghub-month-tpl" \
-H 'Content-Type: application/json' \
-d '{
  "order": 0,
  "index_patterns": ["logstash-loghub-*"],
  "settings": {
    "index": {
      "number_of_shards": "3",
      "number_of_replicas": "0"
    }
  }
}'
```

## 注意事项

1. **影响范围**: 只影响新创建的索引，不影响已有索引
2. **生效时间**: 立即生效，次日创建的索引使用新配置
3. **性能验证**: 建议观察3天，确认集群状态同步时间改善
4. **告警调整**: 需要调整分片数量相关的监控告警阈值

## 执行时机建议

- **最佳时间**: 业务低峰期 (凌晨2-4点)
- **执行顺序**: 先清理旧模板，再创建新模板
- **验证方法**: 创建测试索引验证模板匹配
- **监控重点**: 次日索引创建时的分片数量